name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  BIN_NAME: koi

jobs:
  # ── Prepare ───────────────────────────────────────────────────────
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      tag: ${{ steps.meta.outputs.tag }}
      description: ${{ steps.meta.outputs.description }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract version metadata
        id: meta
        shell: bash
        run: |
          VERSION=$(grep -m1 '^version' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          TAG="v${VERSION}"
          DESCRIPTION=$(jq -r '.description // empty' version.json)
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "description=$DESCRIPTION" >> "$GITHUB_OUTPUT"
          echo "Tag: $TAG"
          echo "Version: $VERSION"
          echo "Description: $DESCRIPTION"

  # ── Test ──────────────────────────────────────────────────────────
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Test
        run: cargo test --locked

  # ── Build ─────────────────────────────────────────────────────────
  build:
    needs: [prepare, test]
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            use_cross: true
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            use_cross: true
          - target: x86_64-apple-darwin
            os: macos-latest
            use_cross: false
          - target: aarch64-apple-darwin
            os: macos-latest
            use_cross: false
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            use_cross: false
          - target: aarch64-pc-windows-msvc
            os: windows-latest
            use_cross: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Install cross
        if: matrix.use_cross
        run: cargo install cross --locked

      - name: Build
        shell: bash
        run: |
          if [ "${{ matrix.use_cross }}" = "true" ]; then
            cross build --release --locked --target ${{ matrix.target }}
          else
            cargo build --release --locked --target ${{ matrix.target }}
          fi

      - name: Package
        shell: bash
        run: |
          VERSION="${{ needs.prepare.outputs.tag }}"
          TARGET="${{ matrix.target }}"
          ARCHIVE_DIR="${BIN_NAME}-${VERSION}-${TARGET}"
          mkdir "$ARCHIVE_DIR"

          # Copy binary
          BIN_SUFFIX=""
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            BIN_SUFFIX=".exe"
          fi
          cp "target/${TARGET}/release/${BIN_NAME}${BIN_SUFFIX}" "$ARCHIVE_DIR/"

          # Copy docs and licenses
          cp README.md "$ARCHIVE_DIR/" 2>/dev/null || true
          cp LICENSE* "$ARCHIVE_DIR/" 2>/dev/null || true

          # Create archive
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            7z a "${ARCHIVE_DIR}.zip" "$ARCHIVE_DIR"
            echo "ASSET=${ARCHIVE_DIR}.zip" >> "$GITHUB_ENV"
          else
            tar czf "${ARCHIVE_DIR}.tar.gz" "$ARCHIVE_DIR"
            echo "ASSET=${ARCHIVE_DIR}.tar.gz" >> "$GITHUB_ENV"
          fi

      - name: Checksum
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            sha256sum "${{ env.ASSET }}" > "${{ env.ASSET }}.sha256"
          else
            shasum -a 256 "${{ env.ASSET }}" > "${{ env.ASSET }}.sha256"
          fi
          cat "${{ env.ASSET }}.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: |
            ${{ env.ASSET }}
            ${{ env.ASSET }}.sha256

  # ── Release ───────────────────────────────────────────────────────
  release:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: release-*
          merge-multiple: true

      - name: Generate release notes
        shell: bash
        run: |
          VERSION="${{ needs.prepare.outputs.tag }}"
          DESCRIPTION="${{ needs.prepare.outputs.description }}"

          # Read the template and substitute
          TEMPLATE=$(cat .github/release-template.md)
          NOTES="${TEMPLATE//\$\{VERSION\}/$VERSION}"
          NOTES="${NOTES//\$\{DESCRIPTION\}/$DESCRIPTION}"

          # Build checksums table
          CHECKSUMS=""
          for f in artifacts/*.sha256; do
            HASH=$(cut -d' ' -f1 "$f")
            FILE=$(basename "${f%.sha256}")
            CHECKSUMS="${CHECKSUMS}${HASH}  ${FILE}"$'\n'
          done
          NOTES="${NOTES//\$\{CHECKSUMS\}/$CHECKSUMS}"

          echo "$NOTES" > release-notes.md
          echo "--- Release notes ---"
          cat release-notes.md

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.prepare.outputs.tag }}"
          # Clean slate: delete any existing release for this tag
          gh release delete "$TAG" --yes 2>/dev/null || true
          # Delete existing tag if present (so we can re-tag at current commit)
          git tag -d "$TAG" 2>/dev/null || true
          git push origin ":refs/tags/$TAG" 2>/dev/null || true
          # Create tag at current commit and release
          git tag "$TAG"
          git push origin "$TAG"
          gh release create "$TAG" \
            --title "$TAG" \
            --notes-file release-notes.md \
            artifacts/*

  # ── Publish to crates.io ───────────────────────────────────────
  publish:
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          # crates.io rate limits:
          #   PublishNew:    burst 5, refill 1 token per 10 min
          #   PublishUpdate: burst 30, refill 1 token per 1 min
          #
          # On first publish all 12 crates are "new" — we can only do 5 before
          # waiting 10 min for a token. On subsequent releases they are "updates"
          # (burst 30) so delays are just for index propagation.
          #
          # Strategy: publish in dependency order, inserting a 10-min pause
          # after every 5th crate to stay within the new-crate bucket.

          # ── Batch 1 (crates 1-5) ──────────────────────────────
          # Layer 0: no internal deps
          cargo publish -p koi-common --locked
          sleep 30

          # Layer 1: depends on koi-common only
          cargo publish -p koi-config --locked
          sleep 20
          cargo publish -p koi-crypto --locked
          sleep 20
          cargo publish -p koi-truststore --locked
          sleep 20
          cargo publish -p koi-mdns --locked

          echo "Batch 1 done (5 crates). Waiting 10 min for rate limit refill..."
          sleep 600

          # ── Batch 2 (crates 6-10) ─────────────────────────────
          # Layer 2: depends on layer 0-1
          cargo publish -p koi-certmesh --locked
          sleep 30

          # Layer 3: depends on layer 0-2
          cargo publish -p koi-dns --locked
          sleep 20
          cargo publish -p koi-proxy --locked
          sleep 30

          # Layer 4: depends on layer 0-3
          cargo publish -p koi-health --locked
          sleep 30

          # Layer 5: depends on health + mdns
          cargo publish -p koi-client --locked

          echo "Batch 2 done (5 crates). Waiting 10 min for rate limit refill..."
          sleep 600

          # ── Batch 3 (crates 11-12) ────────────────────────────
          # Layer 6: depends on everything
          cargo publish -p koi-embedded --locked
          sleep 20
          cargo publish -p koi-net --locked
